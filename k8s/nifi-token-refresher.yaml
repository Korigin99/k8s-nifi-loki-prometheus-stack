# NiFi Bearer Token Refresher
# -------------------------------------------------------
# NiFi 2.x는 JWT Bearer 토큰 인증만 지원합니다.
# 이 CronJob이 6시간마다 NiFi에 로그인하여 JWT 토큰을 발급받고
# Kubernetes Secret에 저장합니다.
# Prometheus ServiceMonitor는 해당 Secret을 authorization 필드로 참조합니다.
# -------------------------------------------------------

# NiFi 로그인 자격증명 Secret
apiVersion: v1
kind: Secret
metadata:
  name: nifi-credentials
  namespace: flowkube-monitoring
type: Opaque
stringData:
  username: "admin"
  password: "AdminPassword123"
---
# Prometheus가 참조할 Bearer 토큰 Secret (CronJob이 채워줌)
apiVersion: v1
kind: Secret
metadata:
  name: nifi-bearer-token
  namespace: flowkube-monitoring
type: Opaque
data:
  token: ""   # 최초 배포 후 아래 안내에 따라 Job을 수동 실행하면 채워집니다.
---
# CronJob이 Secret을 수정할 수 있는 권한
apiVersion: v1
kind: ServiceAccount
metadata:
  name: nifi-token-refresher
  namespace: flowkube-monitoring
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: nifi-token-refresher
  namespace: flowkube-monitoring
rules:
- apiGroups: [""]
  resources: ["secrets"]
  resourceNames: ["nifi-bearer-token"]
  verbs: ["get", "patch"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: nifi-token-refresher
  namespace: flowkube-monitoring
subjects:
- kind: ServiceAccount
  name: nifi-token-refresher
  namespace: flowkube-monitoring
roleRef:
  kind: Role
  name: nifi-token-refresher
  apiGroup: rbac.authorization.k8s.io
---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: nifi-token-refresher
  namespace: flowkube-monitoring
spec:
  # NiFi 기본 토큰 유효시간 12h보다 짧은 6시간마다 갱신
  schedule: "0 */6 * * *"
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 2
  failedJobsHistoryLimit: 2
  jobTemplate:
    spec:
      template:
        spec:
          serviceAccountName: nifi-token-refresher
          restartPolicy: OnFailure
          containers:
          - name: refresher
            image: curlimages/curl:latest   # curl만 있으면 충분 - 별도 빌드 불필요
            env:
            - name: NIFI_USERNAME
              valueFrom:
                secretKeyRef:
                  name: nifi-credentials
                  key: username
            - name: NIFI_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: nifi-credentials
                  key: password
            command:
            - sh
            - -c
            - |
              set -e

              # --connect-to 트릭:
              #   URL 호스트명 = "nifi" → TLS SNI로 "nifi"를 전송 (인증서 CN과 일치)
              #   실제 TCP 연결은 Service FQDN으로 리디렉션 (DNS/IP 하드코딩 불필요)
              # NiFi 2.x는 인증서 CN=localhost로 자동 생성합니다.
              # URL 호스트명 = "localhost" → TLS SNI로 "localhost"를 전송 (CN과 일치)
              # 실제 TCP 연결은 Service FQDN으로 리디렉션합니다.
              NIFI_URL="https://localhost:8443"
              NIFI_SVC="nifi.flowkube-admin.svc.cluster.local"
              CONNECT_TO="localhost:8443:${NIFI_SVC}:8443"

              echo "[1/3] NiFi JWT 토큰 발급 중 (SNI=localhost)..."
              TOKEN=$(curl -sf \
                --insecure \
                --connect-to "$CONNECT_TO" \
                -X POST \
                -H "Content-Type: application/x-www-form-urlencoded" \
                -d "username=${NIFI_USERNAME}&password=${NIFI_PASSWORD}" \
                "${NIFI_URL}/nifi-api/access/token")

              if [ -z "$TOKEN" ]; then
                echo "오류: 빈 응답 - NiFi가 준비되지 않았거나 자격증명이 틀렸습니다."
                exit 1
              fi
              echo "[1/3] 토큰 발급 성공"

              echo "[2/3] base64 인코딩..."
              TOKEN_B64=$(printf '%s' "$TOKEN" | base64 | tr -d '\n')

              echo "[3/3] Kubernetes Secret 업데이트..."
              KUBE_TOKEN=$(cat /var/run/secrets/kubernetes.io/serviceaccount/token)
              KUBE_CA=/var/run/secrets/kubernetes.io/serviceaccount/ca.crt

              HTTP_STATUS=$(curl -s -o /tmp/resp.json -w "%{http_code}" \
                -X PATCH \
                --cacert "$KUBE_CA" \
                -H "Authorization: Bearer $KUBE_TOKEN" \
                -H "Content-Type: application/strategic-merge-patch+json" \
                "https://kubernetes.default.svc/api/v1/namespaces/flowkube-monitoring/secrets/nifi-bearer-token" \
                -d "{\"data\":{\"token\":\"${TOKEN_B64}\"}}")

              if [ "$HTTP_STATUS" = "200" ]; then
                echo "[3/3] Secret 갱신 완료 (HTTP 200)"
              else
                echo "오류: Secret 업데이트 실패 (HTTP $HTTP_STATUS)"
                cat /tmp/resp.json
                exit 1
              fi
